## 📍[1. 이미지 분석]
[첨부 파일] colony.py / colony_info.csv / colony_result.png

</br>

### [구현 과정 설명]

#### 1. 문제 정의
    
- 주어진 이미지에서 96-well plate의 각 웰마다 콜로니를 추출하고, 다음 정보를 산출한다.

- 콜로니 영역 시각화 (빨간선)
- 내부 경계(노란 링) 제외
- 각 콜로니의 형상 정보
    - 직경(크기)
    - 가장 밀집한 위치(보라선)
- 결과물:
    - 콜로니 추출 이미지
    - 96개 콜로니의 형상 정보(CSV)
    - 구현 과정 설명

- 본 과제에서는 **정확한 96개 결과 생성과 안정적인 파이프라인**을 목표로 구현하였다.
    

#### 2. 전체 접근 전략 (요약)
- 이미지가 **96-well plate(12×8)** 구조임을 활용하여 웰 분할을 고정(grid 기반)으로 처리
- 웰 내부에서 **림(노란 경계)을 명시적으로 제거**한 뒤 콜로니를 분할
- 조명 변화에 강한 **illumination flatten + percentile threshold** 방식 사용
- 밀집 위치는 단순 중심이 아닌 **텍스처 기반 에너지 중심**으로 계산
- 일부 웰에서 분할이 실패하더라도 **96개 모두 결과가 나오도록 fallback 설계**

#### 3. 처리 파이프라인 상세
    
- 3.1 웰 분할 (Grid)
    - 전체 이미지를 12×8 uniform grid로 분할
    - 촬영 오차를 보정하기 위해 `GRID_SHIFT_X`, `GRID_SHIFT_Y` 적용
    - 각 셀은 하나의 웰 ROI로 처리
    - `grid_debug.png`를 생성하여 사람이 직접 분할 상태를 확인 가능하도록 함
    
    - **이유**
      - Hough 기반 원 검출을 사용할 경우 파라미터 민감도로 인해 웰 중심이 흔들리는 문제가 있었고, 이는 이후 단계 전체를 불안정하게 만들었다.
      - 본 과제에서는 웰 구조가 명확하므로 **결정적인 grid 분할 방식이 더 안정적**이라 판단하였다.


- 3.2 웰 마스크 및 내부 경계(림) 제거
    - 각 웰 ROI에서 원형 `well_mask` 생성
    - `erode` 연산으로 내부 영역(`inner_mask`) 정의
    - `ring = well_mask − inner_mask`로 내부 경계(노란 링) 분리
    - 이후 모든 세그먼트 과정에서 ring 영역은 **강제로 제외**
    - 이를 통해 과제 요구사항인 *“내부 경계 제외”*를 명확히 만족시켰다.

- 3.3 조명 보정 (Illumination Flatten)
    - 웰 내부 조명 편차로 인해 단순 threshold는 불안정
    - 큰 sigma의 Gaussian blur로 배경을 근사한 뒤 정규화:
    - `norm = image / background`
    - 콜로니와 배경의 대비를 안정적으로 확보

- 3.4 콜로니 Blob 분할
    1. 내부 영역(inner_mask)에서 밝기 분포 추출
    2. 대비(sigma)에 따라 adaptive percentile threshold 선택
    3. morphological open/close로 노이즈 제거
    4. connected components로 후보 blob 생성
    5. **seed 위치와의 거리 + 면적 기반 점수**로 최적 blob 선택
    
    이 방식은 콜로니가 약하거나 부분적으로 끊어진 경우에도 비교적 안정적으로 동작했다.

---

- 3.5 밀집 위치(보라선) 계산

- 밀집 위치는 단순 중심이 아닌, **콜로니 내부에서 가장 정보가 밀집된 지점**으로 정의했다.

- 1차:
    - Black-hat 기반 spots를 사용해 seed 위치 탐색
    - 중앙 영역은 명시적으로 제외
- 2차 (blob 존재 시):
    - 라플라시안 기반 텍스처 에너지 계산
    - 에너지 가중 중심을 최종 밀집 위치로 사용

- spots나 texture 정보가 부족한 경우에는 **중앙을 강제로 찍지 않고**, 해당 웰 내에서 가장 강한 응답 위치로 fallback 하도록 설계했다.

---

### 3.6 직경(크기) 산출

- 콜로니 blob contour가 충분할 경우:
    - `fitEllipse`로 장·단축 계산
    - 직경 = (major + minor) / 2
- ellipse fitting이 불가능한 경우:
    - `minEnclosingCircle` 사용
- 콜로니 분할이 실패한 경우:
    - 결과 누락을 방지하기 위해 **웰 원을 fallback으로 그림**
    - 해당 케이스는 CSV에서 면적/형상 값으로 식별 가능

---

## 4. 시행착오 및 개선 사항

### 4.1 Hough 기반 접근 시 문제점

- 초기에는 HoughCircles를 이용해 웰 원을 직접 검출하는 방식을 시도했다.

- 문제점:

    - 파라미터(dp, minDist, param2, radius)에 매우 민감
    - 96개가 검출되더라도 grid assignment 과정에서:
        - 한 셀에 여러 원이 몰리거나
        - 빈 셀이 발생하여 보간이 필요
    - 웰 중심 오차가 누적되면서 blob 분할 및 밀집점 계산이 불안정

- 결론:

    - 본 과제의 핵심은 **웰 검출이 아니라 콜로니 분할**
    - 웰 구조가 고정된 경우, **grid 기반 접근이 더 결정적이고 안정적**이라고 판단

---

### 4.2 “중앙만 찍히는 밀집점” 문제

- 초기 구현에서는 밀집점 계산 실패 시 중심으로 fallback 하도록 되어 있었고, 이로 인해 일부 웰에서 보라점이 의미 없이 중앙에 찍히는 문제가 발생했다.

- 개선:
    - 중앙 fallback 제거
    - spots/texture 정보가 약한 경우에도
        - 해당 웰 내 **최대 응답 위치(bh max)**를 사용
    - 결과적으로 밀집점의 위치 다양성과 해석 가능성이 개선됨

---

## 5. 결과 및 검증

- 총 96개 웰에 대해 결과 생성 확인
- 모든 웰에 대해:
    - 콜로니 경계(빨간선) 표시
    - 밀집 위치(보라선) 표시
- CSV(`colony_info.csv`)에는 96행이 생성되며,
    - 직경, 중심, 밀집 위치 등 정량 정보 포함
- `grid_debug.png`를 통해 웰 분할 상태를 시각적으로 검증 가능

---

## 6. 마무리
- 본 구현은 **96개 결과의 안정적 생성**, **내부 경계 제외**, **정량 정보 산출**을 모두 만족하도록 설계되었으며,

실제 실험 이미지에서 발생할 수 있는 조명 변화, 약한 콜로니, 분할 실패 케이스에 대해서도

결과 누락 없이 후처리 가능한 형태로 구성하였다.
